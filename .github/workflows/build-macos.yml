name: Build macOS

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 0.2.26)'
        required: false
        type: string
      upload-to-r2:
        description: 'Upload to R2'
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      version:
        description: 'Version number (e.g., 0.2.26)'
        required: true
        type: string
      upload-to-r2:
        description: 'Upload to R2'
        required: false
        type: boolean
        default: false

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build macOS DMG (arm64 + x64)
        run: bash apps/electron/scripts/build-dmg.sh
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          GOOGLE_OAUTH_CLIENT_ID: ${{ secrets.GOOGLE_OAUTH_CLIENT_ID }}
          GOOGLE_OAUTH_CLIENT_SECRET: ${{ secrets.GOOGLE_OAUTH_CLIENT_SECRET }}
          SLACK_OAUTH_CLIENT_ID: ${{ secrets.SLACK_OAUTH_CLIENT_ID }}
          SLACK_OAUTH_CLIENT_SECRET: ${{ secrets.SLACK_OAUTH_CLIENT_SECRET }}
          MICROSOFT_OAUTH_CLIENT_ID: ${{ secrets.MICROSOFT_OAUTH_CLIENT_ID }}

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: apps/electron/release/*.dmg
          if-no-files-found: error
          retention-days: 30

      - name: Upload to R2
        if: inputs.upload-to-r2 == true && inputs.version != ''
        run: |
          # Install AWS CLI
          brew install awscli

          # Configure AWS CLI for R2
          aws configure set aws_access_key_id ${{ secrets.R2_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.R2_SECRET_ACCESS_KEY }}
          aws configure set default.region auto

          # Upload DMG files to R2
          for file in apps/electron/release/*.dmg; do
            filename=$(basename "$file")
            aws s3 cp "$file" \
              "s3://craft-plus-releases/releases/v${{ inputs.version }}/$filename" \
              --endpoint-url "https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com"
          done
