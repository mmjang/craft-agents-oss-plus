name: Build Windows

on:
  # 手动触发
  workflow_dispatch:
  # 自动构建已禁用 - 取消注释以下内容可重新启用
  # push:
  #   branches: [main]
  #   paths:
  #     - 'apps/electron/**'
  #     - 'packages/**'
  #     - 'package.json'
  #     - 'bun.lock'
  # pull_request:
  #   branches: [main]
  #   paths:
  #     - 'apps/electron/**'
  #     - 'packages/**'
  #     - 'package.json'
  #     - 'bun.lock'

jobs:
  build-windows:
    runs-on: windows-latest
    env:
      ELECTRON_CACHE: ${{ github.workspace }}\.cache\electron
      ELECTRON_BUILDER_CACHE: ${{ github.workspace }}\.cache\electron-builder
      FAST_CI: 1
      PORTABLE_RUNTIME_SKIP_IF_PRESENT: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.5

      - name: Cache Bun runtime
        uses: actions/cache@v4
        with:
          path: apps/electron/vendor/bun
          key: bun-runtime-${{ runner.os }}-${{ hashFiles('apps/electron/scripts/build-win.ps1') }}

      - name: Cache Electron downloads
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}\.cache\electron
            ${{ github.workspace }}\.cache\electron-builder
          key: electron-cache-${{ runner.os }}-${{ hashFiles('apps/electron/package.json', 'package.json', 'bun.lock') }}

      - name: Build Windows installer
        shell: pwsh
        run: |
          ./apps/electron/scripts/build-win.ps1
        env:
          # OAuth credentials (optional, set in repository secrets)
          GOOGLE_OAUTH_CLIENT_ID: ${{ secrets.GOOGLE_OAUTH_CLIENT_ID }}
          GOOGLE_OAUTH_CLIENT_SECRET: ${{ secrets.GOOGLE_OAUTH_CLIENT_SECRET }}
          SLACK_OAUTH_CLIENT_ID: ${{ secrets.SLACK_OAUTH_CLIENT_ID }}
          SLACK_OAUTH_CLIENT_SECRET: ${{ secrets.SLACK_OAUTH_CLIENT_SECRET }}
          MICROSOFT_OAUTH_CLIENT_ID: ${{ secrets.MICROSOFT_OAUTH_CLIENT_ID }}

      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: apps/electron/release/*.exe
          if-no-files-found: error
          retention-days: 30
