name: Build Windows

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 0.2.26)'
        required: false
        type: string
      upload-to-r2:
        description: 'Upload to R2'
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      version:
        description: 'Version number (e.g., 0.2.26)'
        required: true
        type: string
      upload-to-r2:
        description: 'Upload to R2'
        required: false
        type: boolean
        default: false

jobs:
  build-windows:
    runs-on: windows-latest
    env:
      ELECTRON_CACHE: ${{ github.workspace }}\.cache\electron
      ELECTRON_BUILDER_CACHE: ${{ github.workspace }}\.cache\electron-builder
      FAST_CI: 1
      PORTABLE_RUNTIME_SKIP_IF_PRESENT: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.5

      - name: Cache Bun runtime
        uses: actions/cache@v4
        with:
          path: apps/electron/vendor/bun
          key: bun-runtime-${{ runner.os }}-${{ hashFiles('apps/electron/scripts/build-win.ps1') }}

      - name: Cache Electron downloads
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}\.cache\electron
            ${{ github.workspace }}\.cache\electron-builder
          key: electron-cache-${{ runner.os }}-${{ hashFiles('apps/electron/package.json', 'package.json', 'bun.lock') }}

      - name: Build Windows installer
        shell: pwsh
        run: |
          ./apps/electron/scripts/build-win.ps1
        env:
          GOOGLE_OAUTH_CLIENT_ID: ${{ secrets.GOOGLE_OAUTH_CLIENT_ID }}
          GOOGLE_OAUTH_CLIENT_SECRET: ${{ secrets.GOOGLE_OAUTH_CLIENT_SECRET }}
          SLACK_OAUTH_CLIENT_ID: ${{ secrets.SLACK_OAUTH_CLIENT_ID }}
          SLACK_OAUTH_CLIENT_SECRET: ${{ secrets.SLACK_OAUTH_CLIENT_SECRET }}
          MICROSOFT_OAUTH_CLIENT_ID: ${{ secrets.MICROSOFT_OAUTH_CLIENT_ID }}

      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: apps/electron/release/*.exe
          if-no-files-found: error
          retention-days: 30

      - name: Upload to R2
        if: inputs.upload-to-r2 == true && inputs.version != ''
        shell: pwsh
        run: |
          # Install AWS CLI
          choco install awscli -y
          refreshenv

          # Configure AWS CLI for R2
          aws configure set aws_access_key_id ${{ secrets.R2_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.R2_SECRET_ACCESS_KEY }}
          aws configure set default.region auto

          # Upload EXE files to R2
          Get-ChildItem -Path "apps/electron/release/*.exe" | ForEach-Object {
            $filename = $_.Name
            aws s3 cp $_.FullName `
              "s3://craft-agents-releases/releases/v${{ inputs.version }}/$filename" `
              --endpoint-url "https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com"
          }
